["b1bee5f967cb479f7ca12ad651648cab9332577d","fa5c498e8a033c412b9d83a574759b07f695de1f",["../index.js","../fs.js","../utils/uuid","../utils/log.js","./EventTarget"],[116,210,297,392,496],{"version":3,"sources":["/home/giise/candidtwo/node_modules/react-native-fetch-blob/polyfill/Blob.js"],"names":["log","blobCacheDir","dirs","DocumentDir","disable","Blob","_ref","unlink","then","mkdir","data","cType","Promise","resolve","reject","onCreated","level","defer","isRNFetchBlobPolyfill","multipartBoundary","_blobCreated","_onCreated","_closed","cacheName","getBlobName","isDerived","type","verbose","length","p","size","String","getRNFetchBlobRef","orgPath","exists","exist","writeFile","catch","err","FormData","boundary","Date","now","parts","getParts","formArray","i","push","part","j","headers","string","createMixedBlobData","startsWith","_isReference","replace","stat","encoding","mime","test","toString","Array","isArray","_invokeOnCreateEvent","error","fn","_isDerived","start","end","contentType","resPath","pass","debug","result","wrap","slice","dest","console","warn","readFile","fns","ref","dataArray","args","written","arg","appendFile","bind"],"mappings":"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","sourcesContent":["// Copyright 2016 wkh237@github. All rights reserved.\n// Use of this source code is governed by a MIT-style license that can be\n// found in the LICENSE file.\n\nimport RNFetchBlob from '../index.js'\nimport fs from '../fs.js'\nimport getUUID from '../utils/uuid'\nimport Log from '../utils/log.js'\nimport EventTarget from './EventTarget'\n\nconst log = new Log('Blob')\nconst blobCacheDir = fs.dirs.DocumentDir + '/RNFetchBlob-blobs/'\n\nlog.disable()\n// log.level(3)\n\n/**\n * A RNFetchBlob style Blob polyfill class, this is a Blob which compatible to\n * Response object attain fron RNFetchBlob.fetch.\n */\nexport default class Blob extends EventTarget {\n\n  cacheName:string;\n  type:string;\n  size:number;\n  isRNFetchBlobPolyfill:boolean = true;\n  multipartBoundary:string = null;\n\n  _ref:string = null;\n  _blobCreated:boolean = false;\n  _onCreated:Array<any> = [];\n  _closed:boolean = false;\n\n  /**\n   * Static method that remove all files in Blob cache folder.\n   * @nonstandard\n   * @return {Promise}\n   */\n  static clearCache() {\n    return fs.unlink(blobCacheDir).then(() => fs.mkdir(blobCacheDir))\n  }\n\n  static build(data:any, cType:any):Promise<Blob> {\n    return new Promise((resolve, reject) => {\n      new Blob(data, cType).onCreated(resolve)\n    })\n  }\n\n  get blobPath() {\n    return this._ref\n  }\n\n  static setLog(level:number) {\n    if(level === -1)\n      log.disable()\n    else\n      log.level(level)\n  }\n\n  /**\n   * RNFetchBlob Blob polyfill, create a Blob directly from file path, BASE64\n   * encoded data, and string. The conversion is done implicitly according to\n   * given `mime`. However, the blob creation is asynchronously, to register\n   * event `onCreated` is need to ensure the Blob is creadted.\n   * @param  {any} data Content of Blob object\n   * @param  {any} mime Content type settings of Blob object, `text/plain`\n   *                    by default\n   * @param  {boolean} defer When this argument set to `true`, blob constructor\n   *                         will not invoke blob created event automatically.\n   */\n  constructor(data:any, cType:any, defer:boolean) {\n    super()\n    cType = cType || {}\n    this.cacheName = getBlobName()\n    this.isRNFetchBlobPolyfill = true\n    this.isDerived = defer\n    this.type = cType.type || 'text/plain'\n    log.verbose('Blob constructor called', 'mime', this.type, 'type', typeof data, 'length', data?  data.length:0)\n    this._ref = blobCacheDir + this.cacheName\n    let p = null\n    if(!data)\n      data = ''\n    if(data.isRNFetchBlobPolyfill) {\n      log.verbose('create Blob cache file from Blob object')\n      let size = 0\n      this._ref = String(data.getRNFetchBlobRef())\n      let orgPath = this._ref\n\n      p = fs.exists(orgPath)\n            .then((exist) =>  {\n              if(exist)\n                return fs.writeFile(orgPath, data, 'uri')\n                         .then((size) => Promise.resolve(size))\n                         .catch((err) => {\n                           throw `RNFetchBlob Blob file creation error, ${err}`\n                         })\n              else\n                throw `could not create Blob from path ${orgPath}, file not exists`\n            })\n    }\n    // process FormData\n    else if(data instanceof FormData) {\n      log.verbose('create Blob cache file from FormData', data)\n      let boundary = `RNFetchBlob-${this.cacheName}-${Date.now()}`\n      this.multipartBoundary = boundary\n      let parts = data.getParts()\n      let formArray = []\n      if(!parts) {\n        p = fs.writeFile(this._ref, '', 'utf8')\n      }\n      else {\n        for(let i in parts) {\n          formArray.push('\\r\\n--'+boundary+'\\r\\n')\n          let part = parts[i]\n          for(let j in part.headers) {\n            formArray.push(j + ': ' +part.headers[j] + '\\r\\n')\n          }\n          formArray.push('\\r\\n')\n          if(part.isRNFetchBlobPolyfill)\n            formArray.push(part)\n          else\n            formArray.push(part.string)\n        }\n        log.verbose('FormData array', formArray)\n        formArray.push('\\r\\n--'+boundary+'--\\r\\n')\n        p = createMixedBlobData(this._ref, formArray)\n      }\n    }\n    // if the data is a string starts with `RNFetchBlob-file://`, append the\n    // Blob data from file path\n    else if(typeof data === 'string' && data.startsWith('RNFetchBlob-file://')) {\n      log.verbose('create Blob cache file from file path', data)\n      // set this flag so that we know this blob is a wrapper of an existing file\n      this._isReference = true\n      this._ref = String(data).replace('RNFetchBlob-file://', '')\n      let orgPath = this._ref\n      if(defer)\n        return\n      else {\n        p = fs.stat(orgPath)\n              .then((stat) =>  {\n                return Promise.resolve(stat.size)\n              })\n      }\n    }\n    // content from variable need create file\n    else if(typeof data === 'string') {\n      let encoding = 'utf8'\n      let mime = String(this.type)\n      // when content type contains application/octet* or *;base64, RNFetchBlob\n      // fs will treat it as BASE64 encoded string binary data\n      if(/(application\\/octet|\\;base64)/i.test(mime))\n        encoding = 'base64'\n      else\n        data = data.toString()\n      // create cache file\n      this.type = String(this.type).replace(/;base64/ig, '')\n      log.verbose('create Blob cache file from string', 'encode', encoding)\n      p = fs.writeFile(this._ref, data, encoding)\n            .then((size) => {\n              return Promise.resolve(size)\n            })\n\n    }\n    // TODO : ArrayBuffer support\n    // else if (data instanceof ArrayBuffer ) {\n    //\n    // }\n    // when input is an array of mixed data types, create a file cache\n    else if(Array.isArray(data)) {\n      log.verbose('create Blob cache file from mixed array', data)\n      p = createMixedBlobData(this._ref, data)\n    }\n    else {\n      data = data.toString()\n      p = fs.writeFile(this._ref, data, 'utf8')\n            .then((size) => Promise.resolve(size))\n    }\n    p && p.then((size) => {\n      this.size = size\n      this._invokeOnCreateEvent()\n    })\n    .catch((err) => {\n      log.error('RNFetchBlob could not create Blob : '+ this._ref, err)\n    })\n\n  }\n\n  /**\n   * Since Blob content will asynchronously write to a file during creation,\n   * use this method to register an event handler for Blob initialized event.\n   * @nonstandard\n   * @param  {(b:Blob) => void} An event handler invoked when Blob created\n   * @return {Blob} The Blob object instance itself\n   */\n  onCreated(fn:() => void):Blob {\n    log.verbose('#register blob onCreated', this._blobCreated)\n    if(!this._blobCreated)\n      this._onCreated.push(fn)\n    else {\n      fn(this)\n    }\n    return this\n  }\n\n  markAsDerived() {\n    this._isDerived = true\n  }\n\n  get isDerived() {\n    return this._isDerived || false\n  }\n\n  /**\n   * Get file reference of the Blob object.\n   * @nonstandard\n   * @return {string} Blob file reference which can be consumed by RNFetchBlob fs\n   */\n  getRNFetchBlobRef() {\n    return this._ref\n  }\n\n  /**\n   * Create a Blob object which is sliced from current object\n   * @param  {number} start    Start byte number\n   * @param  {number} end      End byte number\n   * @param  {string} contentType Optional, content type of new Blob object\n   * @return {Blob}\n   */\n  slice(start:?number, end:?number, contentType:?string=''):Blob {\n    if(this._closed)\n      throw 'Blob has been released.'\n    log.verbose('slice called', start, end, contentType)\n\n\n    let resPath = blobCacheDir + getBlobName()\n    let pass = false\n    log.debug('fs.slice new blob will at', resPath)\n    let result = new Blob(RNFetchBlob.wrap(resPath), { type : contentType }, true)\n    fs.exists(blobCacheDir)\n    .then((exist) => {\n      if(exist)\n        return Promise.resolve()\n      return fs.mkdir(blobCacheDir)\n    })\n    .then(() => fs.slice(this._ref, resPath, start, end))\n    .then((dest) => {\n      log.debug('fs.slice done', dest)\n      result._invokeOnCreateEvent()\n      pass = true\n    })\n    .catch((err) => {\n      console.warn('Blob.slice failed:', err)\n      pass = true\n    })\n    log.debug('slice returning new Blob')\n\n    return result\n  }\n\n  /**\n   * Read data of the Blob object, this is not standard method.\n   * @nonstandard\n   * @param  {string} encoding Read data with encoding\n   * @return {Promise}\n   */\n  readBlob(encoding:string):Promise<any> {\n    if(this._closed)\n      throw 'Blob has been released.'\n    return fs.readFile(this._ref, encoding || 'utf8')\n  }\n\n  /**\n   * Release the resource of the Blob object.\n   * @nonstandard\n   * @return {Promise}\n   */\n  close() {\n    if(this._closed)\n      return Promise.reject('Blob has been released.')\n    this._closed = true\n    return fs.unlink(this._ref).catch((err) => {\n      console.warn(err)\n    })\n  }\n\n  safeClose() {\n    if(this._closed)\n      return Promise.reject('Blob has been released.')\n    this._closed = true\n    if(!this._isReference) {\n      return fs.unlink(this._ref).catch((err) => {\n        console.warn(err)\n      })   \n    }\n    else {\n      return Promise.resolve()\n    }\n  }\n\n  _invokeOnCreateEvent() {\n    log.verbose('invoke create event', this._onCreated)\n    this._blobCreated = true\n    let fns = this._onCreated\n    for(let i in fns) {\n      if(typeof fns[i] === 'function') {\n        fns[i](this)\n      }\n    }\n    delete this._onCreated\n  }\n\n}\n\n/**\n * Get a temp filename for Blob object\n * @return {string} Temporary filename\n */\nfunction getBlobName() {\n  return 'blob-' + getUUID()\n}\n\n/**\n * Create a file according to given array. The element in array can be a number,\n * Blob, String, Array.\n * @param  {string} ref File path reference\n * @param  {Array} dataArray An array contains different types of data.\n * @return {Promise}\n */\nfunction createMixedBlobData(ref, dataArray) {\n  // create an empty file for store blob data\n  let p = fs.writeFile(ref, '')\n  let args = []\n  let size = 0\n  for(let i in dataArray) {\n    let part = dataArray[i]\n    if(!part)\n      continue\n    if(part.isRNFetchBlobPolyfill) {\n      args.push([ref, part._ref, 'uri'])\n    }\n    else if(typeof part === 'string')\n      args.push([ref, part, 'utf8'])\n    // TODO : ArrayBuffer\n    // else if (part instanceof ArrayBuffer) {\n    //\n    // }\n    else if (Array.isArray(part))\n      args.push([ref, part, 'ascii'])\n  }\n  // start write blob data\n  for(let i in args) {\n    p = p.then(function(written){\n      let arg = this\n      if(written)\n        size += written\n      log.verbose('mixed blob write', args[i], written)\n      return fs.appendFile(...arg)\n    }.bind(args[i]))\n  }\n  return p.then(() => Promise.resolve(size))\n}\n"]}]